[supervisord]
nodaemon=true
user=root  # Changed from laravel to root for system process management
logfile=/var/log/supervisor/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700
chown=root:root  # Added ownership
username=admin  # Changed from laravel
password=%(ENV_SUPERVISOR_PASSWORD)s  # Use environment variable

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock
username=admin
password=%(ENV_SUPERVISOR_PASSWORD)s  # Use environment variable

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:nginx]
command=nginx -g "daemon off; error_log /dev/stderr info;"
user=root
autostart=true
autorestart=unexpected  # Only restart on unexpected exits
startretries=3
startsecs=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

[program:php-fpm]
command=php-fpm -F -R
user=root
autostart=true
autorestart=unexpected
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=20

[program:laravel-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/html/artisan queue:work --sleep=3 --tries=3 --max-time=3600 --timeout=60
user=laravel
autostart=true
autorestart=true
numprocs=%(ENV_NUM_WORKERS)s  # Make configurable via env
redirect_stderr=true
stdout_logfile=/var/log/supervisor/laravel-worker.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stopwaitsecs=3600
stopasgroup=true
killasgroup=true
priority=30
environment=
    APP_ENV="%(ENV_APP_ENV)s",
    APP_NAME="%(ENV_APP_NAME)s"

[program:horizon]
command=php /var/www/html/artisan horizon
user=laravel
autostart=%(ENV_ENABLE_HORIZON)s  # Make configurable via env
autorestart=true
stdout_logfile=/var/log/supervisor/horizon.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/var/log/supervisor/horizon-error.log
stderr_logfile_maxbytes=50MB
stopwaitsecs=60
priority=40
environment=
    APP_ENV="%(ENV_APP_ENV)s",
    APP_NAME="%(ENV_APP_NAME)s"